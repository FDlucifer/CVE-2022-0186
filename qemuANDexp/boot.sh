#! /bin/sh
mkdir rootfs
cd rootfs
cpio -idmv < ../rootfs.img
cd ../exp
make cve-2022-0185
cp ./exp-cve-2022-0185  ../rootfs/
cd ../

cd ./rootfs
find . | cpio -o --format=newc > ../rootfs.img
cd ../

qemu-system-x86_64 \
-m 1G \
-kernel ./bzImage \
-initrd  ./rootfs.img \
-nographic \
-append "console=ttyS0 root=/dev/sda rw nokaslr quiet" \
-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \
-cpu kvm64,+smep,+smap \
-gdb tcp::10086

